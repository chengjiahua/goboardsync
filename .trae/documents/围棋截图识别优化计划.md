# 围棋截图识别优化计划

## 问题分析
当前识别成功率仅43%，主要问题：
1. 棋盘定位不准确，常截取部分棋盘
2. 棋子识别错误，坐标偏移
3. 无法识别棋子，返回None
4. 手数识别错误

## 实施步骤

### 阶段1：棋盘几何定位与矫正

1. **图像预处理**
   - 实现图像缩放（长边缩放到1280或1600）
   - 灰度化与高斯模糊

2. **棋盘四角定位**
   - 实现Canny边缘检测
   - 实现HoughLinesP直线检测
   - 按角度分类水平线和垂直线
   - 过滤过短线段
   - 推断外框线并计算四角点
   - 实现角点合法性检查

3. **透视矫正**
   - 实现warpPerspective，将棋盘矫正为1024×1024的正视棋盘
   - 处理回退策略（当四角定位失败时）

### 阶段2：当前手棋子定位

1. **角标颜色检测**
   - 根据手数确定目标颜色（偶数=白=蓝标，奇数=黑=红标）
   - 实现HSV颜色空间转换
   - 实现颜色分割（蓝/红阈值）
   - 实现形态学去噪
   - 实现轮廓提取与筛选
   - 确定角标中心点

2. **棋子中心定位**
   - 从角标推断棋子中心初值
   - 实现局部圆检测微调中心
   - 计算19×19交叉点网格
   - 将棋子中心映射到最近交叉点

3. **置信度计算与验证**
   - 计算中心到最近交叉点距离
   - 实现置信度计算
   - 实现棋子上的手数数字二次验证

### 代码结构优化

1. **模块拆分**
   - boardlocate：棋盘定位与矫正
   - markdetect：角标检测
   - stonecenter：棋子中心定位
   - gridmap：网格映射
   - verify：OCR验证
   - debug：调试输出

2. **接口设计**
   - 实现符合用户要求的Result结构
   - 实现DetectLastMoveCoord函数

3. **测试与调试**
   - 实现调试图像输出
   - 优化测试逻辑
   - 提高测试成功率

## 技术要点

1. **使用gocv库实现OpenCV功能**
2. **优化HSV颜色阈值以提高角标检测准确率**
3. **实现稳健的棋盘定位算法**
4. **添加手数数字验证以降低误检率**
5. **优化性能以满足实时性要求**

## 预期成果

- 提高测试成功率到90%以上
- 单张处理耗时≤50ms
- 实现完整的两阶段识别流程
- 提供详细的调试信息